local players = game:GetService("Players")
local player  = players.LocalPlayer

local ESP = {
    connections = {},
    highlights = {},

    
    settings = {
        teamCheck = false,

        enemyFillColor = Color3.new(1, 0, 0),   
        enemyOutlineColor = Color3.new(0.24, 0.02, 0.02),
        teamFillColor = Color3.new(0, 1, 0),        
        teamOutlineColor = Color3.new(0.03, 0.24, 0.02),
        noTeamFillColor = Color3.new(1, 1, 0),      
        noTeamOutlineColor = Color3.new(0.24, 0.24, 0.02),
        fillTransparency = 0.5
    }
}

getgenv().espEnabled = false


function ESP._draw(char,plr)
    if not char then return end 

    local highlight = Instance.new("Highlight")
    highlight.Parent = char
    highlight.Name = "ESPHighlight"
    highlight.FillColor = ESP.settings.noTeamFillColor
    highlight.OutlineColor = ESP.settings.noTeamOutlineColor

    local myTeam = player.Team 
    local enemyTeam = plr.Team

    if ESP.settings.teamCheck then
        if enemyTeam == myTeam then 
            highlight.FillColor = ESP.settings.teamFillColor
            highlight.OutlineColor = ESP.settings.teamOutlineColor
        else 
            highlight.FillColor = ESP.settings.enemyFillColor
            highlight.OutlineColor = ESP.settings.enemyOutlineColor
        end 
    end

    highlight.FillTransparency = ESP.settings.fillTransparency

    local ancCheck = char.AncestryChanged:Connect(function()
        if not char:IsDescendantOf(game) then 
            ESP.highlights[char] = nil 
        end 
    end)

    table.insert(ESP.connections, ancCheck)
    ESP.highlights[char] = highlight 

end

function ESP._onCharacterAdded(char,plr)
    ESP._draw(char,plr)
end

function ESP._onPlayerAdded(pl)
    local characterAddedConnection = pl.CharacterAdded:Connect(function(char)
        ESP._onCharacterAdded(char,pl)
    end)

    table.insert(ESP.connections,characterAddedConnection)

    if pl.Character then 
        ESP._onCharacterAdded(pl.Character,pl)
    end 
end

function ESP._cleanUp()
    getgenv().espEnabled = false

    for i,v in ESP.connections do 
        if v then 
            v:Disconnect()
        end 
    end 
    ESP.connections = {}
    warn("Connections Cleaned")

    for i,v in ESP.highlights do 
        if v then 
            v:Remove()
        end 
    end 
    ESP.highlights = {}

    warn("Esp Removed!")
end

function ESP._init()
    getgenv().espEnabled = true

    -- add joined players
    local playerAddedConnection = players.PlayerAdded:Connect(function(pl)
        ESP._onPlayerAdded(pl)
    end)

    table.insert(ESP.connections,playerAddedConnection)

    -- add current players 
    for i,v in players:GetPlayers() do 
        ESP._onPlayerAdded(v)
    end 

    repeat task.wait(0.5)

    until getgenv().espEnabled == false 
    
    ESP._cleanUp()
end




return ESP
